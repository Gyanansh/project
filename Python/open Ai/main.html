<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J.A.R.V.I.S. AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a1a;
            color: #e0e0ff;
        }
        .jarvis-container {
            border: 2px solid #00d4ff;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.4), inset 0 0 20px rgba(0, 212, 255, 0.2);
            backdrop-filter: blur(10px);
            background: rgba(10, 10, 30, 0.7);
        }
        .chat-bubble {
            border-radius: 1rem;
            padding: 1rem;
            max-width: 80%;
            word-wrap: break-word;
        }
        .user-bubble {
            background-color: #1a1a3a;
            border: 1px solid #3a3a5a;
            align-self: flex-end;
        }
        .jarvis-bubble {
            background-color: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            align-self: flex-start;
        }
        .hud-element {
            position: absolute;
            border: 1px solid rgba(0, 212, 255, 0.3);
            pointer-events: none;
        }
        #mic-button.listening {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 212, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 212, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 212, 255, 0); }
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a1a; }
        ::-webkit-scrollbar-thumb { background: #00d4ff; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #00aaff; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <!-- Decorative HUD elements for the futuristic feel -->
    <div class="hud-element" style="top: 20px; left: 20px; width: 100px; height: 50px;"></div>
    <div class="hud-element" style="bottom: 20px; right: 20px; width: 150px; height: 70px; border-radius: 50%;"></div>
    <div class="hud-element" style="top: 30%; right: 40px; width: 2px; height: 100px;"></div>
    <div class="hud-element" style="bottom: 40%; left: 30px; width: 80px; height: 2px;"></div>

    <main class="jarvis-container w-full max-w-4xl h-[90vh] rounded-2xl flex flex-col p-6 relative">
        <header class="text-center mb-4">
            <h1 class="text-3xl font-bold text-[#00d4ff] tracking-widest">J.A.R.V.I.S.</h1>
            <p id="status" class="text-sm text-gray-400">Online and ready to assist</p>
        </header>
        
        <div id="chat-log" class="flex-grow overflow-y-auto pr-4 flex flex-col gap-4">
            <!-- Chat messages will be appended here -->
        </div>

        <footer class="mt-6 flex items-center gap-4">
            <input type="text" id="user-input" class="flex-grow bg-transparent border border-[#00d4ff] rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-[#00d4ff] text-white" placeholder="Type or say a command...">
            <button id="mic-button" class="p-3 bg-[#00d4ff] text-[#0a0a1a] rounded-full hover:bg-opacity-80 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-[#0a0a1a] focus:ring-[#00d4ff]">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                    <line x1="12" y1="19" x2="12" y2="22"></line>
                </svg>
            </button>
        </footer>
    </main>

    <script>
        const chatLog = document.getElementById('chat-log');
        const userInput = document.getElementById('user-input');
        const micButton = document.getElementById('mic-button');
        const statusElement = document.getElementById('status');

        const apiKey = ""; // API key is not needed for this model
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        // --- Speech Recognition (Voice Input) ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let isListening = false;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;

            recognition.onstart = () => {
                isListening = true;
                micButton.classList.add('listening');
                statusElement.textContent = 'Listening...';
            };

            recognition.onend = () => {
                isListening = false;
                micButton.classList.remove('listening');
                statusElement.textContent = 'Online and ready to assist';
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                userInput.value = transcript;
                processCommand(transcript);
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                if (event.error === 'not-allowed') {
                    speak("It seems I don't have permission to access the microphone. Please enable it in your browser settings.");
                } else {
                    speak("I'm having trouble with my audio processors. Please try typing your command.");
                }
            };
        } else {
            speak("It appears your browser does not support voice commands. You can still type your requests.");
            micButton.disabled = true;
        }

        micButton.addEventListener('click', () => {
            if (isListening) {
                recognition.stop();
            } else {
                if(recognition) recognition.start();
            }
        });

        // --- Speech Synthesis (Voice Output) ---
        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.voice = speechSynthesis.getVoices().find(voice => voice.name.includes("Google US English")) || speechSynthesis.getVoices()[0];
            utterance.pitch = 0.9;
            utterance.rate = 1.1;
            speechSynthesis.speak(utterance);
            displayMessage(text, 'jarvis');
        }

        // --- Display Messages ---
        function displayMessage(message, sender) {
            const bubble = document.createElement('div');
            bubble.classList.add('chat-bubble', sender === 'user' ? 'user-bubble' : 'jarvis-bubble');
            bubble.textContent = message;
            chatLog.appendChild(bubble);
            chatLog.scrollTop = chatLog.scrollHeight; // Auto-scroll to the bottom
        }

        // --- Command Processing ---
        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                const command = userInput.value.trim();
                if (command) {
                    processCommand(command);
                    userInput.value = '';
                }
            }
        });

        function processCommand(command) {
            displayMessage(command, 'user');
            const lowerCaseCommand = command.toLowerCase();

            // --- Pre-defined local commands ---
            if (lowerCaseCommand.includes('what time is it') || lowerCaseCommand.includes('current time')) {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
                speak(`The current time is ${timeString}.`);
                return;
            }

            if (lowerCaseCommand.includes('what is today') || lowerCaseCommand.includes("today's date")) {
                const now = new Date();
                const dateString = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                speak(`Today is ${dateString}.`);
                return;
            }

            if (lowerCaseCommand.includes('clear chat') || lowerCaseCommand.includes('clear log')) {
                chatLog.innerHTML = '';
                speak('Log cleared, sir.');
                return;
            }
            
            // --- If not a local command, call Gemini API ---
            callGeminiAPI(command);
        }

        async function callGeminiAPI(prompt) {
            statusElement.textContent = 'Processing...';
            const systemPrompt = "You are J.A.R.V.I.S., a sophisticated AI assistant created by Tony Stark. Your personality is witty, helpful, and slightly sarcastic. You are highly intelligent and efficient. Keep your responses concise and to the point, addressing the user as 'sir' or 'miss' occasionally. You must not break character.";
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const textResponse = candidate.content.parts[0].text;
                    speak(textResponse);
                } else {
                    console.error('Unexpected API response structure:', result);
                    speak("I'm sorry, sir. I encountered a communication error. It seems my response was not properly formatted.");
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                speak("Apologies, sir. I seem to be having trouble connecting to my primary servers. Please try again in a moment.");
            } finally {
                statusElement.textContent = 'Online and ready to assist';
            }
        }
        
        // --- Initial Greeting ---
        window.onload = () => {
            // Wait for voices to be loaded before speaking
            speechSynthesis.onvoiceschanged = () => {
                setTimeout(() => {
                    speak("Good evening. J.A.R.V.I.S. online and at your service.");
                }, 100);
            };
        };

    </script>
</body>
</html>
